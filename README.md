# Integration Hub "bisnesmedia"

Этот проект представляет собой интеграционный сервис (хаб) для автоматизации бизнес-процессов между системами «1С: Управление торговлей 11» и «МойСклад».

## Prerequisites

Для локальной разработки и запуска вам понадобятся:
- [Docker](https://www.docker.com/) и Docker Compose
- [Poetry](https://python-poetry.org/)

## Установка и Настройка

1. **Клонируйте репозиторий:**
   ```bash
   git clone <your-repo-url>
   cd bisnesmedia-integration-hub
   ```

2. **Создайте файл конфигурации:**
   Скопируйте пример файла с переменными окружения и заполните его вашими данными.
   ```bash
   cp .env.example .env
   ```
   > Важно: файл `.env` не должен попадать в систему контроля версий.

3. **Установите зависимости:**
   Poetry создаст виртуальное окружение и установит все необходимые пакеты.
   ```bash
   poetry install
   ```

## Запуск

### Локальная разработка

Используйте файл `docker-compose.dev.yml` (hot-reload, локальная сборка образов):

```bash
docker compose -f docker-compose.dev.yml up -d --build
```

Сервис будет доступен по адресу: http://localhost:8000

Документация API (Swagger UI): http://localhost:8000/docs

Здоровье:

```text
GET /            -> { status: ok }
GET /health/db   -> проверка доступности БД
```

Подсказки:
- Если после обновления зависимостей видите ошибки импорта при перезагрузке, пересоберите без кэша:

  ```bash
  docker compose -f docker-compose.dev.yml build --no-cache app
  docker compose -f docker-compose.dev.yml build --no-cache admin_panel
  docker compose -f docker-compose.dev.yml up -d
  ```

- В dev можно отключить миграции на старте: установите `RUN_MIGRATIONS_ON_STARTUP=false` в `.env`.

## Тестирование подключения к API 1С

Для быстрой проверки корректности API-кредов (URL, логин, пароль) из `.env` файла, можно использовать специальный скрипт.

1. Убедитесь, что ваш `.env` файл заполнен актуальными данными для `API_1C_*`.
2. Запустите скрипт из корневой директории проекта:

```bash
poetry run python scripts/test_1c_connection.py
```

Скрипт выведет в консоль подробный отчет об успехе или ошибке подключения.

## Запуск Тестов

Для запуска всех тестов (модульных и интеграционных) выполните команду:

```bash
poetry run pytest
```

## Структура Проекта

Проект имеет строгую многоуровневую архитектуру для обеспечения чистоты и сопровождаемости кода. Подробное описание каждого модуля и его назначения находится в документе `PROJECT_STRUCTURE.md`.

База данных: приложение использует асинхронный драйвер `asyncpg` через SQLAlchemy 2.x. Первичная таблица `integration_logs` создаётся миграцией и предназначена для логирования процесса интеграций в режиме read-only.

### API Endpoints

- `POST /api/v1/trigger/internal-replenishment`: Асинхронно запускает процесс внутреннего пополнения.

### Фоновые процессы

Система использует фоновый планировщик задач (`APScheduler`) для выполнения отложенных и регулярных операций:

- Обработчик Outbox: Каждые 30 секунд проверяет наличие новых задач на отправку данных в 1С и выполняет их. Это гарантирует, что даже при кратковременном сбое API, заказ в конечном итоге будет создан.
- Внутреннее пополнение: Каждый будний день в 9:00 по московскому времени автоматически запускает основной процесс анализа дефицита и создания заказов на перемещение.

### Доступные Сервисы

- API Сервис: http://localhost:8000
- API Документация: http://localhost:8000/docs
- Панель Администратора: http://localhost:8501

### Запуск в Production

В production используется файл `docker-compose.yml`, который подтягивает готовые образы из GHCR:

```bash
docker compose up -d
```

Перед запуском замените плейсхолдеры образов `ghcr.io/your-github-username/your-repo-name/...` в `docker-compose.yml` на реальные пути (например, `ghcr.io/<owner>/<repo>/app:latest`).

## CI/CD

При пуше в ветку `main` GitHub Actions запускает пайплайн:

- Линтинг (`ruff`) и статический анализ (`mypy`).
- Тесты (`pytest`) с тестовой PostgreSQL.
- Сборка и публикация Docker-образов приложения и админ‑панели в GitHub Container Registry (GHCR) с тегами `latest` и SHA коммита.

### Алгоритм Работы

1. Анализ дефицита в 1С: система находит товары, у которых остаток ниже минимального значения.
2. Поиск на складах-донорах: проверяются склады "Бестужевых" и "Контейнер".
3. Создание внутреннего перемещения: если товар найден, создается запись в outbox для создания "Заказа на перемещение" в 1С, затем Outbox-процессор создаёт документ.
4. Создание внешнего заказа: если товар не найден на внутренних складах, создаётся запись в outbox для создания "Заказа покупателя" в МойСклад; процессор отправляет заказ в МойСклад.

## Обновления Docker/Compose

- Многоэтапные Dockerfile: оба образа (приложение и админ‑панель) собираются через Poetry с вмонтированным `.venv` внутри контейнера.
- Локальная сборка в dev: `docker-compose.dev.yml` убирает `image:` и использует `build` с `Dockerfile`/`Dockerfile.admin`.
- Команды запуска: используются бинарники Python из `.venv` внутри контейнера, а для приложения включён `--reload`.

## Управление зависимостями

- Добавить runtime‑зависимость (приложение):
  `docker compose -f docker-compose.dev.yml run --rm app poetry add <package-name>`
- Добавить dev‑зависимость (админка/инструменты):
  `docker compose -f docker-compose.dev.yml run --rm admin_panel poetry add -G dev <package-name>`
- Обновить lock‑файл локально в активированном `.venv` (рекомендуется):
  `& .\.venv\Scripts\Activate.ps1; poetry lock`
- Пересобрать контейнеры после изменения зависимостей:
  `docker compose -f docker-compose.dev.yml up -d --build`

Примечание: выполнение `poetry add` внутри контейнера меняет файлы зависимостей в контейнере. Чтобы изменения зафиксировались в репозитории, обновляйте lock локально (как выше) или смонтируйте корень проекта в сервис перед выполнением команды.
